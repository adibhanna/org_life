#!/bin/bash

# Maintenance script for organization system
# Run weekly or monthly to keep everything organized

set -e

source "$HOME/.organize_config" 2>/dev/null || BASE_DIR="$HOME/Life"

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

# Maintenance log
LOG_FILE="$BASE_DIR/System/maintenance.log"
mkdir -p "$(dirname $LOG_FILE)"

log_action() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $@" >> "$LOG_FILE"
}

print_header() {
    echo -e "${BOLD}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${BOLD}       ðŸ”§ Organization System Maintenance${NC}"
    echo -e "${BOLD}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo
}

# Check inbox status
check_inbox() {
    echo -e "${CYAN}ðŸ“¥ Checking Inbox...${NC}"

    for dir in "$BASE_DIR"/Inbox/*; do
        if [ -d "$dir" ]; then
            count=$(find "$dir" -type f 2>/dev/null | wc -l)
            dirname=$(basename "$dir")

            if [ $count -gt 0 ]; then
                echo -e "  ${YELLOW}âš ${NC}  $dirname: $count files need sorting"
            else
                echo -e "  ${GREEN}âœ“${NC} $dirname: Empty"
            fi
        fi
    done
    echo
}

# Find duplicate files
find_duplicates() {
    echo -e "${CYAN}ðŸ” Finding duplicate files...${NC}"

    # Use MD5 checksums to find duplicates
    find "$BASE_DIR" -type f -not -path "*/\.*" -not -path "*/Archive/*" -exec md5sum {} + 2>/dev/null | \
        sort | uniq -w32 -d --all-repeated=separate | \
        grep -v '^$' | head -20

    if [ $? -eq 0 ]; then
        echo -e "${YELLOW}Found potential duplicates (showing first 20)${NC}"
    else
        echo -e "${GREEN}âœ“ No duplicate files found${NC}"
    fi
    echo
}

# Find large files
find_large_files() {
    echo -e "${CYAN}ðŸ“Š Finding large files (>100MB)...${NC}"

    find "$BASE_DIR" -type f -size +100M -not -path "*/Archive/*" 2>/dev/null | while read file; do
        size=$(du -h "$file" | cut -f1)
        echo -e "  ${YELLOW}$size${NC} - ${file#$BASE_DIR/}"
    done | head -10

    echo
}

# Check for old files that should be archived
check_archive_candidates() {
    echo -e "${CYAN}ðŸ“¦ Files ready for archiving (>90 days old)...${NC}"

    ARCHIVE_DAYS=${ARCHIVE_AFTER_DAYS:-90}
    count=0

    find "$BASE_DIR" -type f -mtime +$ARCHIVE_DAYS \
        -not -path "*/Archive/*" \
        -not -path "*/System/*" \
        -not -path "*/Personal/Documents/*" \
        2>/dev/null | while read file; do
        count=$((count + 1))
        if [ $count -le 10 ]; then
            echo -e "  ${file#$BASE_DIR/}"
        fi
    done

    total=$(find "$BASE_DIR" -type f -mtime +$ARCHIVE_DAYS \
        -not -path "*/Archive/*" \
        -not -path "*/System/*" \
        2>/dev/null | wc -l)

    if [ $total -gt 0 ]; then
        echo -e "${YELLOW}Total: $total files can be archived${NC}"
        echo -e "Run 'org-archive' to move them to Archive/"
    else
        echo -e "${GREEN}âœ“ No files need archiving${NC}"
    fi
    echo
}

# Clean empty directories
clean_empty_dirs() {
    echo -e "${CYAN}ðŸ§¹ Cleaning empty directories...${NC}"

    count=0
    while IFS= read -r dir; do
        if [ -z "$(ls -A "$dir" 2>/dev/null)" ]; then
            echo -e "  Removing: ${dir#$BASE_DIR/}"
            rmdir "$dir" 2>/dev/null && count=$((count + 1))
        fi
    done < <(find "$BASE_DIR" -type d -not -path "*/\.*" 2>/dev/null)

    if [ $count -gt 0 ]; then
        echo -e "${GREEN}âœ“ Removed $count empty directories${NC}"
    else
        echo -e "${GREEN}âœ“ No empty directories found${NC}"
    fi
    echo
}

# Generate statistics
generate_stats() {
    echo -e "${CYAN}ðŸ“ˆ System Statistics:${NC}"

    total_size=$(du -sh "$BASE_DIR" 2>/dev/null | cut -f1)
    total_files=$(find "$BASE_DIR" -type f 2>/dev/null | wc -l)
    total_dirs=$(find "$BASE_DIR" -type d 2>/dev/null | wc -l)

    echo -e "  Total Size: ${BOLD}$total_size${NC}"
    echo -e "  Total Files: ${BOLD}$total_files${NC}"
    echo -e "  Total Directories: ${BOLD}$total_dirs${NC}"
    echo

    echo -e "${CYAN}Top 5 Categories by Size:${NC}"
    du -sh "$BASE_DIR"/* 2>/dev/null | sort -hr | head -5 | while read size dir; do
        dirname=$(basename "$dir")
        echo -e "  $size - $dirname"
    done
    echo
}

# Backup reminder
backup_reminder() {
    echo -e "${CYAN}ðŸ’¾ Backup Status:${NC}"

    BACKUP_DIR="$BASE_DIR/System/Backups"
    if [ -d "$BACKUP_DIR" ]; then
        latest=$(ls -t "$BACKUP_DIR" 2>/dev/null | head -1)
        if [ -n "$latest" ]; then
            echo -e "  Last backup: $latest"

            # Check if backup is older than 7 days
            if [ -f "$BACKUP_DIR/$latest" ]; then
                age=$(find "$BACKUP_DIR/$latest" -mtime +7 2>/dev/null | wc -l)
                if [ $age -gt 0 ]; then
                    echo -e "  ${YELLOW}âš  Backup is older than 7 days${NC}"
                else
                    echo -e "  ${GREEN}âœ“ Backup is recent${NC}"
                fi
            fi
        else
            echo -e "  ${RED}âœ— No backups found${NC}"
        fi
    else
        echo -e "  ${YELLOW}âš  Backup directory not found${NC}"
    fi
    echo
}

# Optimization suggestions
provide_suggestions() {
    echo -e "${CYAN}ðŸ’¡ Optimization Suggestions:${NC}"

    # Check for files with bad naming
    bad_names=$(find "$BASE_DIR" -name "* *" -o -name "*(*" -o -name "*)*" 2>/dev/null | wc -l)
    if [ $bad_names -gt 0 ]; then
        echo -e "  ${YELLOW}â€¢${NC} $bad_names files have spaces or special characters in names"
    fi

    # Check for very deep nesting
    deep_dirs=$(find "$BASE_DIR" -mindepth 6 -type d 2>/dev/null | wc -l)
    if [ $deep_dirs -gt 0 ]; then
        echo -e "  ${YELLOW}â€¢${NC} $deep_dirs directories are nested more than 5 levels deep"
    fi

    # Check for files without extensions
    no_ext=$(find "$BASE_DIR" -type f ! -name "*.*" -not -path "*/\.*" 2>/dev/null | wc -l)
    if [ $no_ext -gt 0 ]; then
        echo -e "  ${YELLOW}â€¢${NC} $no_ext files don't have file extensions"
    fi

    echo
}

# Main execution
main() {
    print_header

    log_action "Starting maintenance check"

    check_inbox
    find_duplicates
    find_large_files
    check_archive_candidates
    clean_empty_dirs
    generate_stats
    backup_reminder
    provide_suggestions

    log_action "Maintenance check completed"

    echo -e "${BOLD}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${GREEN}âœ“ Maintenance check complete!${NC}"
    echo -e "${BOLD}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo
    echo -e "Next steps:"
    echo -e "  1. Run ${CYAN}org-inbox-process${NC} to sort inbox items"
    echo -e "  2. Run ${CYAN}org-archive${NC} to archive old files"
    echo -e "  3. Review and delete duplicate files if needed"
    echo -e "  4. Create a backup if it's been more than a week"
}

# Handle arguments
case "${1:-}" in
    --auto)
        # Automated mode for cron
        main 2>&1 | tee -a "$LOG_FILE"
        ;;
    --help)
        echo "Usage: org-maintenance [--auto|--help]"
        echo ""
        echo "Options:"
        echo "  --auto   Run in automated mode (for cron)"
        echo "  --help   Show this help message"
        echo ""
        echo "Run without arguments for interactive mode"
        ;;
    *)
        main
        ;;
esac