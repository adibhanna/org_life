#!/bin/bash

# Process files in the inbox interactively
# Helps sort files from Inbox to their proper locations

set -e

source "$HOME/.organize_config" 2>/dev/null || BASE_DIR="$HOME/Life"

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

INBOX_DIR="$BASE_DIR/Inbox/ToSort"

# Check if inbox has files
if [ ! -d "$INBOX_DIR" ]; then
    echo -e "${RED}Inbox directory not found: $INBOX_DIR${NC}"
    exit 1
fi

FILES=($(find "$INBOX_DIR" -type f -not -name ".*" 2>/dev/null))
COUNT=${#FILES[@]}

if [ $COUNT -eq 0 ]; then
    echo -e "${GREEN}âœ“ Inbox is empty! Great job staying organized.${NC}"
    exit 0
fi

echo -e "${BOLD}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${BOLD}       ğŸ“¥ Inbox Processing - $COUNT file(s) to sort${NC}"
echo -e "${BOLD}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo

# Define destinations
declare -a DESTINATIONS=(
    "Work/Projects/Active|Work - Active Projects"
    "Work/Projects/Archive|Work - Archived Projects"
    "Code/Projects/Personal|Code - Personal Projects"
    "Code/Learning/Resources|Code - Learning Resources"
    "Finance/Receipts/$(date +%Y)|Finance - Receipts"
    "Finance/Documents|Finance - Documents"
    "Personal/Documents|Personal - Documents"
    "Content/Writing/Ideas|Content - Ideas"
    "Content/Graphics/Assets|Content - Graphics"
    "Education/Books/Library|Education - Books"
    "Health/Medical/Records|Health - Medical"
    "Archive/$(date +%Y)|Archive - Current Year"
    "DELETE|Delete this file"
    "SKIP|Skip for now"
)

# Process each file
for FILE in "${FILES[@]}"; do
    clear
    FILENAME=$(basename "$FILE")
    FILESIZE=$(du -h "$FILE" | cut -f1)
    FILETYPE=$(file -b "$FILE" | cut -d',' -f1)

    echo -e "${BOLD}File: ${CYAN}$FILENAME${NC}"
    echo -e "Size: $FILESIZE"
    echo -e "Type: $FILETYPE"
    echo -e "${BOLD}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"

    # Preview file content if text
    if file "$FILE" | grep -q "text"; then
        echo -e "${BOLD}Preview:${NC}"
        head -n 5 "$FILE" 2>/dev/null | sed 's/^/  /'
        echo -e "  ..."
        echo
    fi

    echo -e "${BOLD}Where should this file go?${NC}"
    echo

    # Display destination options
    for i in "${!DESTINATIONS[@]}"; do
        IFS='|' read -r path desc <<< "${DESTINATIONS[$i]}"
        printf "${BLUE}%2d)${NC} %s\n" $((i+1)) "$desc"
    done

    echo
    read -p "Enter choice (1-${#DESTINATIONS[@]}): " choice

    if [[ $choice -ge 1 && $choice -le ${#DESTINATIONS[@]} ]]; then
        IFS='|' read -r path desc <<< "${DESTINATIONS[$((choice-1))]}"

        if [ "$path" = "DELETE" ]; then
            read -p "Are you sure you want to delete '$FILENAME'? (y/N) " -n 1 -r
            echo
            if [[ $REPLY =~ ^[Yy]$ ]]; then
                rm "$FILE"
                echo -e "${RED}âœ— Deleted: $FILENAME${NC}"
            else
                echo -e "${YELLOW}âŠ˜ Skipped deletion${NC}"
            fi
        elif [ "$path" = "SKIP" ]; then
            echo -e "${YELLOW}â†’ Skipped: $FILENAME${NC}"
        else
            DEST_DIR="$BASE_DIR/$path"
            mkdir -p "$DEST_DIR"

            # Add date prefix to filename
            DATE=$(date +%Y-%m-%d)
            NEW_NAME="${DATE}_${FILENAME}"

            mv "$FILE" "$DEST_DIR/$NEW_NAME"
            echo -e "${GREEN}âœ“ Moved to: $path/$NEW_NAME${NC}"
        fi
    else
        echo -e "${YELLOW}Invalid choice, skipping...${NC}"
    fi

    echo
    read -p "Press Enter to continue..." -n 1 -r
done

# Final summary
REMAINING=($(find "$INBOX_DIR" -type f -not -name ".*" 2>/dev/null))
echo
echo -e "${BOLD}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${GREEN}âœ“ Processing complete!${NC}"
echo -e "Files remaining in inbox: ${#REMAINING[@]}"
echo -e "${BOLD}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"